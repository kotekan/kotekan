##########################################
#
##########################################
---
type: config
# Logging level can be one of:
# OFF, ERROR, WARN, INFO, DEBUG, DEBUG2 (case insensitive)
# Note DEBUG and DEBUG2 require a build with (-DCMAKE_BUILD_TYPE=Debug)
log_level: debug
#    log_level: info
cpu_affinity: [2,3,4,5,8,9,10,11]
frame_arrival_period: 0.001

buffer_depth: 4

# data gen:
num_frames: 20

input_size: 4
frame_size: 4

rechunk_factor: 5

# Pool
main_pool:
    kotekan_metadata_pool: chordMetadata
    num_metadata_objects: 15 * buffer_depth

# Buffers
host_in_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    # frame_size: 
    metadata_pool: main_pool

# Buffer used for signalling only, between the two GPU pipelines.
host_mid_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: 0
    metadata_pool: main_pool

host_out_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: input_size * rechunk_factor
    metadata_pool: main_pool

gen_data:
    kotekan_stage: testDataGen
    type: const8
    values: [0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07]
    #    array_shape: [64, 16]
    #dim_name: ["X", "Y"]
    out_buf: host_in_buffer

gpuA:
    # log_level: debug
    profiling: true
    log_profiling: true
    kernel_path: "../../lib/cuda/kernels/"
    commands: &command_list
    - name: cudaInputData
      in_buf: host_in
      gpu_mem: in
    - name: cudaSyncInput
    - name: cudaRechunk
      gpu_mem_input: in
      gpu_mem_output: chunk
      output_async: true
      #input_columns_field: frb_bf_bytes_per_freq
      cols_input: 1
      cols_output: rechunk_factor
      rows: input_size
      set_flag: rechunked
    - name: cudaSyncOutput
      required_flag: rechunked
    - name: cudaOutputData
      required_flag: rechunked
      out_buf: host_mid
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        commands: *command_list
        in_buffers:
            host_in: host_in_buffer
        out_buffers:
            host_mid: host_mid_buffer

gpuB:
    profiling: true
    log_profiling: true
    kernel_path: "../../lib/cuda/kernels/"
    commands: &command_list2
    - name: cudaInputData
      in_buf: host_mid
    #- name: cudaSyncOutput
    - name: cudaOutputData
      #gpu_mem: in
      gpu_mem: chunk
      out_buf: host_out
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        commands: *command_list2
        in_buffers:
            host_mid: host_mid_buffer
        out_buffers:
            host_out: host_out_buffer

# print:
#     kotekan_stage: hexDump
#     in_buf: host_out_buffer
#     len: 20
print:
    kotekan_stage: printSparseUint8
    input_buf: host_out_buffer
    max_to_print: 20
