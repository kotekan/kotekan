##########################################
#
# verify_cuda_n2k.yaml
#
# Config to test Kendrick's cuda N2 tensor-core kernel.
#
##########################################
---
type: config
# Logging level can be one of:
# OFF, ERROR, WARN, INFO, DEBUG, DEBUG2 (case insensitive)
# Note DEBUG and DEBUG2 require a build with (-DCMAKE_BUILD_TYPE=Debug)
log_level: debug
#num_links: 4
#freq_array: [4,7,10,16]
#timesamples_per_packet: 2

#num_data_sets: 1
num_gpus: 1
buffer_depth: 4
num_gpu_frames: 4
cpu_affinity: [2,3,4,5,8,9,10,11]
sizeof_float: 4
frame_arrival_period: 0.00000256 * samples_per_data_set
sizeof_int: 4

# For faster CHORD testing, we're using...
sub_integration_ntime: 1024
samples_per_data_set: 2048
#sub_integration_ntime: 16384
#samples_per_data_set: 32768
num_elements: 1024
num_local_freq: 16
# vis matrix size
vis_blocks_tr_root: (num_elements + 1) / 16
num_vis_blocks: vis_blocks_tr_root * (vis_blocks_tr_root + 1) / 2

# Pool
main_pool:
    kotekan_metadata_pool: chordMetadata
    num_metadata_objects: 15 * buffer_depth

# Buffers
host_voltage_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: samples_per_data_set * num_elements * num_local_freq
    metadata_pool: main_pool

host_correlation_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_local_freq * (samples_per_data_set / sub_integration_ntime) * 16 * 16 * num_vis_blocks * 2 * sizeof_int
    metadata_pool: main_pool

simulated_correlation_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_local_freq * (samples_per_data_set / sub_integration_ntime) * 16 * 16 * num_vis_blocks * 2 * sizeof_int
    metadata_pool: main_pool

# Ringbuffer signalling buffer
host_voltage_ringbuffer:
    kotekan_buffer: ring
    ring_buffer_size: buffer_depth * samples_per_data_set * num_elements * num_local_freq
    metadata_pool: main_pool

gen_data:
    type: const
    value: 2
    kotekan_stage: testDataGen
    out_buf: host_voltage_buffer
    array_shape: [ 2048, 16, 2, 512 ]
    dim_name: ["T", "F", "P", "D" ]

run_send_voltage:
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_voltage_buffer_in: host_voltage_buffer
        out_buffers:
            host_voltage_ringbuffer_out: host_voltage_ringbuffer
        commands:
        - name: cudaCopyToRingbuffer
          input_size: samples_per_data_set * num_elements * num_local_freq
          ring_buffer_size: buffer_depth * input_size
          in_buf: host_voltage_buffer_in
          signal_buf: host_voltage_ringbuffer_out
          gpu_mem_output: voltage_buffer

run_n2k:
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_voltage_ringbuffer_in: host_voltage_ringbuffer
        out_buffers:
            host_correlation: host_correlation_buffer
        commands:
        - name: cudaCorrelator
          in_signal: host_voltage_ringbuffer_in
          gpu_mem_voltage: voltage_buffer
          gpu_mem_correlation_triangle: correlation_matrix
        - name: cudaSyncOutput
        - name: cudaOutputData
          gpu_mem: correlation_matrix
          out_buf: host_correlation

cpu:
    kotekan_stage: gpuSimulateN2k
    log_level: debug
    network_in_buf: host_voltage_buffer
    corr_out_buf: simulated_correlation_buffer

check_data:
    kotekan_stage: testDataCheckInt
    first_buf: host_correlation_buffer
    second_buf: simulated_correlation_buffer
    num_frames_to_test: buffer_depth
