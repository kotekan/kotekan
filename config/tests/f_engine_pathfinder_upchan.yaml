##########################################
#
# F-Engine Data Generator
#
##########################################
---
type: config
log_level: debug   # info
cpu_affinity: [0,1,2,3,4,5,6,7]
buffer_depth: 4

frame_arrival_period: 2.56e-6 * num_times

sizeof_int16: 2
sizeof_int32: 4
sizeof_float16: 2

# Basic constants
num_components: 2
num_polarizations: 2

# F-Engine simulator: Sky
source_amplitude: 1.0
source_frequency: 0.3e+9        # [Hz]
source_position_x: 0.02         # east-west
source_position_y: 0.03         # north-south

# F-Engine simulator: Dishes
num_dish_locations_M: 8         # north-south
num_dish_locations_N: 12        # east-west
num_dish_locations: num_dish_locations_M * num_dish_locations_N
dish_separation_x: 6.3          # [m] east-west
dish_separation_y: 8.5          # [m] north-south
num_dishes: 64

# 8*12 = 96 dish locations. Dishes 0..63 are real dishes, dishes
# 64..95 are dummy dishes where the E-field is set to zero.
# The actual dishes live on an 11x6 grid.
dish_locations: [
    # actual dishes
                0, 2, 0, 3, 0, 4, 0, 5, 0, 6, 0, 7, 0, 8, 0, 9, 0, 10,
    1, 0, 1, 1, 1, 2, 1, 3, 1, 4, 1, 5, 1, 6, 1, 7, 1, 8, 1, 9, 1, 10,
    2, 0, 2, 1, 2, 2, 2, 3, 2, 4, 2, 5, 2, 6, 2, 7, 2, 8, 2, 9, 2, 10,
    3, 0, 3, 1, 3, 2, 3, 3, 3, 4, 3, 5, 3, 6, 3, 7, 3, 8, 3, 9, 3, 10,
    4, 0, 4, 1, 4, 2, 4, 3, 4, 4, 4, 5, 4, 6, 4, 7, 4, 8, 4, 9, 4, 10,
    5, 0, 5, 1, 5, 2, 5, 3, 5, 4, 5, 5, 5, 6, 5, 7, 5, 8, 5, 9, 5, 10,
    # dummy dishes
    0, 0, 0, 1,
                                                                       0, 11,
                                                                       1, 11,
                                                                       2, 11,
                                                                       3, 11,
                                                                       4, 11,
                                                                       5, 11,
    6, 0, 6, 1, 6, 2, 6, 3, 6, 4, 6, 5, 6, 6, 6, 7, 6, 8, 6, 9, 6, 10, 6, 11,
    7, 0, 7, 1, 7, 2, 7, 3, 7, 4, 7, 5, 7, 6, 7, 7, 7, 8, 7, 9, 7, 10, 7, 11,
]

# F-Engine simulator: ADC
adc_frequency: 3.0e+9           # [Hz]
num_samples_per_frame: 2048

# F-Engine simulator: FT (PFB)
num_taps: 4
num_frequencies: 128            # how many frequencies to keep
num_times: 32768

# Baseband beamformer setup
bb_num_dishes_M: 8
bb_num_dishes_N: 8
bb_num_beams_P: 4
bb_num_beams_Q: 4
bb_beam_separation_x: 0.015        # east-west
bb_beam_separation_y: 0.015        # north-south
bb_num_beams: bb_num_beams_P * bb_num_beams_Q

# Upchannelizer setup
upchannelization_factor: 16

# FRB beamformer setup
frb_downsampling_factor: 40
frb_num_output_times: num_times / frb_downsampling_factor # rounding down
frb_num_beams_P: 2 * num_dish_locations_M
frb_num_beams_Q: 2 * num_dish_locations_N

# Pool:
main_pool:
    kotekan_metadata_pool: chordMetadata
    num_metadata_objects: 10 * buffer_depth

# Buffers
host_dish_locations_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_int16 * 2 * num_dish_locations
    metadata_pool: main_pool

host_bb_phase_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_components * num_dishes * bb_num_beams * num_polarizations * num_frequencies
    metadata_pool: main_pool

host_bb_shift_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_int32 * bb_num_beams * num_polarizations * num_frequencies
    metadata_pool: main_pool

host_upchan_gain_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_float16 * num_frequencies * upchannelization_factor
    metadata_pool: main_pool

host_frb_phase_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_float16 * num_components * num_dish_locations_M * num_dish_locations_N * num_frequencies * num_polarizations
    metadata_pool: main_pool

host_voltage_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_dishes * num_polarizations * num_frequencies * num_times
    metadata_pool: main_pool

host_expected_bb_beams_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_times * num_polarizations * num_frequencies * bb_num_beams
    metadata_pool: main_pool

host_upchan_voltage_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_dishes * num_polarizations * (num_frequencies * upchannelization_factor) * (num_times / upchannelization_factor)
    metadata_pool: main_pool

# Stages
gen_voltage:
    kotekan_stage: FEngine
    num_frames: 10
    E_buffer: host_voltage_buffer
    A_buffer: host_bb_phase_buffer
    J_buffer: host_expected_bb_beams_buffer
    S_buffer: host_dish_locations_buffer
    G_buffer: host_upchan_gain_buffer
    W_buffer: host_frb_phase_buffer

gpu:
    kernel_path: "lib/cuda/kernels"
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_voltage: host_voltage_buffer
            host_upchan_gain: host_upchan_gain_buffer
        out_buffers:
            host_upchan_voltage: host_upchan_voltage_buffer
        commands:
        - name: cudaInputData
          in_buf: host_voltage
          gpu_mem: voltage
        - name: cudaInputData
          in_buf: host_upchan_gain
          gpu_mem: upchan_gain
        - name: cudaSyncInput
        - name: cudaUpchannelizer_pathfinder_U16
          gpu_mem_input_voltage: voltage
          gpu_mem_gain: upchan_gain
          gpu_mem_output_voltage: upchan_voltage
        - name: cudaSyncOutput
        - name: cudaOutputData
          gpu_mem: upchan_voltage
          out_buf: host_upchan_voltage

write_data:
    base_dir: /tmp/f_engine_pathfinder_upchan
    exit_after_n_frames: 10
    exit_with_n_writers: 3
    write_voltage:
        kotekan_stage: asdfFileWrite
        in_buf: host_voltage_buffer
        file_name: voltage
    write_gain:
        kotekan_stage: asdfFileWrite
        in_buf: host_upchan_gain_buffer
        file_name: upchan_gain
    write_upchan_voltage:
        kotekan_stage: asdfFileWrite
        in_buf: host_upchan_voltage_buffer
        file_name: upchan_voltage
...
