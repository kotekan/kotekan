##########################################
#
# FEngine Data Generator
#
##########################################
---
type: config
log_level: debug   # info
cpu_affinity: [0,1,2,3,4,5,6,7]
buffer_depth: 4

frame_arrival_period: 2.56e-6 * num_times

sizeof_int: 4

num_components: 2
num_dishes: 512
num_frequencies: 16
num_polarizations: 2
num_times: 32768
num_beams: 96

# Pool:
main_pool:
    kotekan_metadata_pool: chimeMetadata
    num_metadata_objects: 10 * buffer_depth

# Buffers
host_phase_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_components * num_dishes * num_beams * num_polarizations * num_frequencies
    metadata_pool: main_pool

host_voltage_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_dishes * num_frequencies * num_polarizations * num_times
    metadata_pool: main_pool

host_shift_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_int * num_beams * num_polarizations * num_frequencies
    metadata_pool: main_pool

host_beams_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_times * num_polarizations * num_frequencies * num_beams
    metadata_pool: main_pool

host_wanted_beams_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_times * num_polarizations * num_frequencies * num_beams
    metadata_pool: main_pool

host_info_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    # num_threads * num_warps * num_blocks
    frame_size: sizeof_int * 32 * 24 * 32 * 4
    metadata_pool: main_pool

# Stages
gen_voltage:
    kotekan_stage: FEngine
    num_frames: 1
    samples_per_data_set: num_times
    A_frame_size: num_components * num_dishes * num_beams * num_polarizations * num_frequencies
    E_frame_size: num_dishes * num_frequencies * num_polarizations * num_times
    J_frame_size: num_times * num_polarizations * num_frequencies * num_beams
    A_buffer: host_phase_buffer
    E_buffer: host_voltage_buffer
    J_buffer: host_wanted_beams_buffer

# gen_phase:
#     type: onehot
#     # The value `0x04` leads to an error, probably due to round-off
#     # because we are rounding differently in the C++ and the CUDA
#     # kernels.
#     # TODO: Fix this.
#     values: [0x01, 0x02, 0x03, 0x08, 0x10, 0x20, 0x40, 0x80, 0xff]
#     array_shape: [num_frequencies, num_polarizationes, num_beams, num_dishes, num_components]
#     kotekan_stage: testDataGen
#     out_buf: host_phase_buffer

gen_shift:
    kotekan_stage: testDataGen
    type: const32
    value: 0x4
    out_buf: host_shift_buffer

gpu:
    kernel_path: "lib/cuda/kernels"
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_voltage: host_voltage_buffer
            host_phase: host_phase_buffer
            host_shift: host_shift_buffer
        out_buffers:
            host_beams: host_beams_buffer
            host_info: host_info_buffer
        commands:
        - name: cudaInputData
          in_buf: host_voltage
          gpu_mem: voltage
        - name: cudaInputData
          in_buf: host_phase
          gpu_mem: phase
        - name: cudaInputData
          in_buf: host_shift
          gpu_mem: shift
        - name: cudaSyncInput
        - name: cudaBasebandBeamformer
          num_elements: num_dishes * num_polarizations
          num_local_freq: num_frequencies
          samples_per_data_set: num_times
          gpu_mem_voltage: voltage
          gpu_mem_phase: phase
          gpu_mem_output_scaling: shift
          gpu_mem_formed_beams: beams
          gpu_mem_info: info
        - name: cudaSyncOutput
        - name: cudaOutputData
          in_buf: host_voltage  # Metadata transfer from here
          gpu_mem: beams
          out_buf: host_beams
        - name: cudaOutputData
          in_buf: host_voltage  # Metadata transfer from here
          gpu_mem: info
          out_buf: host_info

write_data:
  base_dir: /tmp
  file_ext: data
  exit_after_n_frames: 1
  exit_with_n_writers: 4
  write_voltage:
    kotekan_stage: hdf5FileWrite
    in_buf: host_voltage_buffer
    file_name: voltage
  write_phase:
    kotekan_stage: hdf5FileWrite
    in_buf: host_phase_buffer
    file_name: phases
  write_wanted_beams:
    kotekan_stage: hdf5FileWrite
    in_buf: host_wanted_beams_buffer
    file_name: wanted_beams
  write_beams:
    kotekan_stage: hdf5FileWrite
    in_buf: host_beams_buffer
    file_name: beams
...
