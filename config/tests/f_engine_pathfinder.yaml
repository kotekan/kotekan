##########################################
#
# F-Engine Data Generator
#
##########################################
---
type: config
log_level: debug   # info
cpu_affinity: [0,1,2,3,4,5,6,7]
buffer_depth: 4
kernel_path: "lib/cuda/kernels"

frame_arrival_period: 2.56e-6 * num_times

sizeof_int16: 2
sizeof_int32: 4
sizeof_float16: 2

# Basic constants
num_components: 2
num_polarizations: 2

# F-Engine simulator: Sky
source_amplitude: 1.0
source_frequency: 0.3e+9        # [Hz]
source_position_ew: 0.02        # east-west
source_position_ns: 0.03        # north-south

# F-Engine simulator: Dishes
num_dish_locations_ew: 12        # east-west
num_dish_locations_ns: 8         # north-south
num_dish_locations: num_dish_locations_ns * num_dish_locations_ew
dish_separation_ew: 6.3          # [m] east-west
dish_separation_ns: 8.5          # [m] north-south
num_dishes: 64

# The actual dishes live on an 11x6 grid.
dish_indices: [
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
    -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,
    -1,-1,-1, 0, 1, 2, 3, 4, 5, 6, 7, 8,
    -1, 9,10,11,12,13,14,15,16,17,18,19,
    -1,20,21,22,23,24,25,26,27,28,29,30,
    -1,31,32,33,34,35,36,37,38,39,40,41,
    -1,42,43,44,45,46,47,48,49,50,51,52,
    -1,53,54,55,56,57,58,59,60,61,62,63,
]

# F-Engine simulator: ADC
adc_frequency: 3.0e+9           # [Hz]
num_samples_per_frame: 2048

# F-Engine simulator: FT (PFB)
num_taps: 4
num_frequencies: 128            # how many frequencies to keep
num_times: 2048   #TODO 32768

# Baseband beamformer setup
bb_num_dishes_M: 8
bb_num_dishes_N: 8
bb_num_beams_P: 4
bb_num_beams_Q: 4
bb_beam_separation_x: 0.015        # east-west
bb_beam_separation_y: 0.015        # north-south
bb_num_beams: bb_num_beams_P * bb_num_beams_Q

# Upchannelizer setup
upchannelization_factor: 16

# FRB beamformer setup
frb_downsampling_factor: 40
frb_num_output_times: num_times / upchannelization_factor / frb_downsampling_factor # rounding down
frb_num_beams_P: 2 * num_dish_locations_ns
frb_num_beams_Q: 2 * num_dish_locations_ew

# Pool:
main_pool:
    kotekan_metadata_pool: chordMetadata
    num_metadata_objects: 10 * buffer_depth

# Buffers
host_bb_phase_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_components * num_dishes * bb_num_beams * num_polarizations * num_frequencies
    metadata_pool: main_pool

host_bb_shift_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_int32 * bb_num_beams * num_polarizations * num_frequencies
    metadata_pool: main_pool

host_upchan_gain_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_float16 * num_frequencies * upchannelization_factor
    metadata_pool: main_pool

host_frb_phase_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_float16 * num_components * num_dish_locations_ns * num_dish_locations_ew * num_frequencies * upchannelization_factor * num_polarizations
    metadata_pool: main_pool

host_voltage_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_dishes * num_polarizations * num_frequencies * num_times
    metadata_pool: main_pool
host_voltage_ringbuffer:
    kotekan_buffer: ring
    ring_buffer_size: buffer_depth * num_dishes * num_polarizations * num_frequencies * num_times
    metadata_pool: main_pool

host_expected_bb_beams_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_times * num_polarizations * num_frequencies * bb_num_beams
    metadata_pool: main_pool

host_expected_frb_beams_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_float16 * frb_num_beams_P * frb_num_beams_Q * num_frequencies * upchannelization_factor * frb_num_output_times
    metadata_pool: main_pool

host_bb_beams_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_times * num_polarizations * num_frequencies * bb_num_beams
    metadata_pool: main_pool

host_upchan_voltage_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_dishes * num_polarizations * (num_frequencies * upchannelization_factor) * (num_times / upchannelization_factor)
    metadata_pool: main_pool
host_upchan_voltage_ringbuffer:
    kotekan_buffer: ring
    ring_buffer_size: buffer_depth * num_dishes * num_polarizations * (num_frequencies * upchannelization_factor) * (num_times / upchannelization_factor)
    metadata_pool: main_pool

host_frb_beams_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_float16 * frb_num_beams_P * frb_num_beams_Q * num_frequencies * upchannelization_factor * frb_num_output_times
    metadata_pool: main_pool
host_frb_beams_ringbuffer:
    kotekan_buffer: ring
    num_frames: buffer_depth
    ring_buffer_size: buffer_depth * sizeof_float16 * frb_num_beams_P * frb_num_beams_Q * num_frequencies * upchannelization_factor * frb_num_output_times
    metadata_pool: main_pool

# Stages
run_fengine:
    kotekan_stage: FEngine
    num_frames: 10
    E_buffer: host_voltage_buffer
    A_buffer: host_bb_phase_buffer
    J_buffer: host_expected_bb_beams_buffer
    G_buffer: host_upchan_gain_buffer
    W_buffer: host_frb_phase_buffer
    I_buffer: host_expected_frb_beams_buffer

run_gen_shift:
    kotekan_stage: testDataGen
    type: const32
    dim_name: ["F", "P", "B"]
    # array_shape: [num_frequencies, num_polarizations, bb_num_beams]
    array_shape: [128, 2, 16]
    value: 13
    out_buf: host_bb_shift_buffer

run_send_voltage:
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_voltage_buffer_in: host_voltage_buffer
        out_buffers:
            host_voltage_ringbuffer_out: host_voltage_ringbuffer
        commands:
        - name: cudaCopyToRingbuffer
          input_size: num_dishes * num_polarizations * num_frequencies * num_times
          ring_buffer_size: buffer_depth * input_size
          in_buf: host_voltage_buffer_in
          signal_buf: host_voltage_ringbuffer_out
          gpu_mem_output: voltage_buffer
        - name: cudaSyncInput

run_bb:
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_voltage_ringbuffer_in: host_voltage_ringbuffer
            host_bb_phase_in: host_bb_phase_buffer
            host_bb_shift_in: host_bb_shift_buffer
        out_buffers:
            host_bb_beams_out: host_bb_beams_buffer
        commands:
        - name: cudaInputData
          in_buf: host_bb_phase_in
          gpu_mem: bb_phase_buffer
        - name: cudaInputData
          in_buf: host_bb_shift_in
          gpu_mem: bb_shift_buffer
        - name: cudaSyncInput
        - name: cudaBasebandBeamformer_pathfinder
          in_signal: host_voltage_ringbuffer_in
          gpu_mem_voltage: voltage_buffer
          gpu_mem_phase: bb_phase_buffer
          gpu_mem_output_scaling: bb_shift_buffer
          gpu_mem_formed_beams: bb_beams_buffer
        - name: cudaSyncOutput
        - name: cudaOutputData
          gpu_mem: bb_beams_buffer
          out_buf: host_bb_beams_out

run_upchan:
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_voltage_ringbuffer_in: host_voltage_ringbuffer
            host_upchan_gain_buffer_in: host_upchan_gain_buffer
        out_buffers:
            host_upchan_voltage_ringbuffer_out: host_upchan_voltage_ringbuffer
        commands:
        - name: cudaInputData
          in_buf: host_upchan_gain_buffer_in
          gpu_mem: upchan_gain_buffer
        - name: cudaSyncInput
        - name: cudaUpchannelizer_pathfinder_U16
          in_signal: host_voltage_ringbuffer_in
          out_signal: host_upchan_voltage_ringbuffer_out
          gpu_mem_input_voltage: voltage_buffer
          gpu_mem_gain: upchan_gain_buffer
          gpu_mem_output_voltage: upchan_voltage_buffer
        - name: cudaSyncOutput

run_recv_upchan_voltage:
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_upchan_voltage_ringbuffer_in: host_upchan_voltage_ringbuffer
        out_buffers:
            host_upchan_voltage_buffer_out: host_upchan_voltage_buffer
        commands:
        - name: cudaCopyFromRingbuffer
          host_signal: host_upchan_voltage_ringbuffer_in
          gpu_mem_input: upchan_voltage_buffer
          output_size: num_dishes * num_polarizations * (num_frequencies * upchannelization_factor) * (num_times / upchannelization_factor)
          ring_buffer_size: buffer_depth * output_size
          out_buf: host_upchan_voltage_buffer_out

run_frb:
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_upchan_voltage_ringbuffer_in: host_upchan_voltage_ringbuffer
            host_frb_phase_buffer_in: host_frb_phase_buffer
        out_buffers:
            host_frb_beams_ringbuffer_out: host_frb_beams_ringbuffer
        commands:
        - name: cudaInputData
          in_buf: host_frb_phase_buffer_in
          gpu_mem: frb_phase_buffer
        - name: cudaSyncInput
        - name: cudaFRBBeamformer_pathfinder
          in_signal: host_upchan_voltage_ringbuffer_in
          out_signal: host_frb_beams_ringbuffer_out
          gpu_mem_voltage: upchan_voltage_buffer
          gpu_mem_phase: frb_phase_buffer
          gpu_mem_beamgrid: frb_beams_buffer
        - name: cudaSyncOutput

run_recv_frb_beams:
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_frb_beams_ringbuffer_in: host_frb_beams_ringbuffer
        out_buffers:
            host_frb_beams_buffer_out: host_frb_beams_buffer
        commands:
        - name: cudaCopyFromRingbuffer
          host_signal: host_frb_beams_ringbuffer_in
          gpu_mem_input: frb_beams_buffer
          output_size: sizeof_float16 * frb_num_beams_P * frb_num_beams_Q * (num_frequencies * upchannelization_factor) * frb_num_output_times
          ring_buffer_size: buffer_depth * output_size
          out_buf: host_frb_beams_buffer_out

write_data:
    base_dir: /tmp/f_engine_pathfinder
    # exit_after_n_frames: 9
    # exit_with_n_writers: 9
    write_voltage:
        kotekan_stage: asdfFileWrite
        in_buf: host_voltage_buffer
        file_name: voltage
    #TODO write_bb_phase:
    #TODO     kotekan_stage: asdfFileWrite
    #TODO     in_buf: host_bb_phase_buffer
    #TODO     file_name: bb_phase
    #TODO write_expected_bb_beams:
    #TODO     kotekan_stage: asdfFileWrite
    #TODO     in_buf: host_expected_bb_beams_buffer
    #TODO     file_name: expected_bb_beams
    #TODO write_bb_beams:
    #TODO     kotekan_stage: asdfFileWrite
    #TODO     in_buf: host_bb_beams_buffer
    #TODO     file_name: bb_beams
    #TODO write_gain:
    #TODO     kotekan_stage: asdfFileWrite
    #TODO     in_buf: host_upchan_gain_buffer
    #TODO     file_name: upchan_gain
    #TODO write_upchan_voltage:
    #TODO     kotekan_stage: asdfFileWrite
    #TODO     in_buf: host_upchan_voltage_buffer
    #TODO     file_name: upchan_voltage
    #TODO write_frb_phase:
    #TODO     kotekan_stage: asdfFileWrite
    #TODO     in_buf: host_frb_phase_buffer
    #TODO     file_name: frb_phase
    #TODO write_expected_frb_beams:
    #TODO     kotekan_stage: asdfFileWrite
    #TODO     in_buf: host_expected_frb_beams_buffer
    #TODO     file_name: expected_frb_beams
    #TODO write_frb_beams:
    #TODO     kotekan_stage: asdfFileWrite
    #TODO     in_buf: host_frb_beams_buffer
    #TODO     file_name: frb_beams
...
