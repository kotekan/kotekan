# -*-yaml-*-

# CHIME F-Engine setup

################################################################################

# Dishes

num_dish_locations_ew: 4        # east-west
num_dish_locations_ns: 256      # north-south
num_dish_locations: num_dish_locations_ns * num_dish_locations_ew
dish_separation_ew: 20.0        # [m] east-west
dish_separation_ns: 0.390625    # [m] north-south
num_dishes: 1024

# The actual dishes live on an 11x6 grid.
dish_indices: [
     0,  64, 128, 192, 256, 320, 384, 448, 512, 576, 640, 704, 768, 832, 896,  960,
     1,  65, 129, 193, 257, 321, 385, 449, 513, 577, 641, 705, 769, 833, 897,  961,
     2,  66, 130, 194, 258, 322, 386, 450, 514, 578, 642, 706, 770, 834, 898,  962,
     3,  67, 131, 195, 259, 323, 387, 451, 515, 579, 643, 707, 771, 835, 899,  963,
     4,  68, 132, 196, 260, 324, 388, 452, 516, 580, 644, 708, 772, 836, 900,  964,
     5,  69, 133, 197, 261, 325, 389, 453, 517, 581, 645, 709, 773, 837, 901,  965,
     6,  70, 134, 198, 262, 326, 390, 454, 518, 582, 646, 710, 774, 838, 902,  966,
     7,  71, 135, 199, 263, 327, 391, 455, 519, 583, 647, 711, 775, 839, 903,  967,
     8,  72, 136, 200, 264, 328, 392, 456, 520, 584, 648, 712, 776, 840, 904,  968,
     9,  73, 137, 201, 265, 329, 393, 457, 521, 585, 649, 713, 777, 841, 905,  969,
    10,  74, 138, 202, 266, 330, 394, 458, 522, 586, 650, 714, 778, 842, 906,  970,
    11,  75, 139, 203, 267, 331, 395, 459, 523, 587, 651, 715, 779, 843, 907,  971,
    12,  76, 140, 204, 268, 332, 396, 460, 524, 588, 652, 716, 780, 844, 908,  972,
    13,  77, 141, 205, 269, 333, 397, 461, 525, 589, 653, 717, 781, 845, 909,  973,
    14,  78, 142, 206, 270, 334, 398, 462, 526, 590, 654, 718, 782, 846, 910,  974,
    15,  79, 143, 207, 271, 335, 399, 463, 527, 591, 655, 719, 783, 847, 911,  975,
    16,  80, 144, 208, 272, 336, 400, 464, 528, 592, 656, 720, 784, 848, 912,  976,
    17,  81, 145, 209, 273, 337, 401, 465, 529, 593, 657, 721, 785, 849, 913,  977,
    18,  82, 146, 210, 274, 338, 402, 466, 530, 594, 658, 722, 786, 850, 914,  978,
    19,  83, 147, 211, 275, 339, 403, 467, 531, 595, 659, 723, 787, 851, 915,  979,
    20,  84, 148, 212, 276, 340, 404, 468, 532, 596, 660, 724, 788, 852, 916,  980,
    21,  85, 149, 213, 277, 341, 405, 469, 533, 597, 661, 725, 789, 853, 917,  981,
    22,  86, 150, 214, 278, 342, 406, 470, 534, 598, 662, 726, 790, 854, 918,  982,
    23,  87, 151, 215, 279, 343, 407, 471, 535, 599, 663, 727, 791, 855, 919,  983,
    24,  88, 152, 216, 280, 344, 408, 472, 536, 600, 664, 728, 792, 856, 920,  984,
    25,  89, 153, 217, 281, 345, 409, 473, 537, 601, 665, 729, 793, 857, 921,  985,
    26,  90, 154, 218, 282, 346, 410, 474, 538, 602, 666, 730, 794, 858, 922,  986,
    27,  91, 155, 219, 283, 347, 411, 475, 539, 603, 667, 731, 795, 859, 923,  987,
    28,  92, 156, 220, 284, 348, 412, 476, 540, 604, 668, 732, 796, 860, 924,  988,
    29,  93, 157, 221, 285, 349, 413, 477, 541, 605, 669, 733, 797, 861, 925,  989,
    30,  94, 158, 222, 286, 350, 414, 478, 542, 606, 670, 734, 798, 862, 926,  990,
    31,  95, 159, 223, 287, 351, 415, 479, 543, 607, 671, 735, 799, 863, 927,  991,
    32,  96, 160, 224, 288, 352, 416, 480, 544, 608, 672, 736, 800, 864, 928,  992,
    33,  97, 161, 225, 289, 353, 417, 481, 545, 609, 673, 737, 801, 865, 929,  993,
    34,  98, 162, 226, 290, 354, 418, 482, 546, 610, 674, 738, 802, 866, 930,  994,
    35,  99, 163, 227, 291, 355, 419, 483, 547, 611, 675, 739, 803, 867, 931,  995,
    36, 100, 164, 228, 292, 356, 420, 484, 548, 612, 676, 740, 804, 868, 932,  996,
    37, 101, 165, 229, 293, 357, 421, 485, 549, 613, 677, 741, 805, 869, 933,  997,
    38, 102, 166, 230, 294, 358, 422, 486, 550, 614, 678, 742, 806, 870, 934,  998,
    39, 103, 167, 231, 295, 359, 423, 487, 551, 615, 679, 743, 807, 871, 935,  999,
    40, 104, 168, 232, 296, 360, 424, 488, 552, 616, 680, 744, 808, 872, 936, 1000,
    41, 105, 169, 233, 297, 361, 425, 489, 553, 617, 681, 745, 809, 873, 937, 1001,
    42, 106, 170, 234, 298, 362, 426, 490, 554, 618, 682, 746, 810, 874, 938, 1002,
    43, 107, 171, 235, 299, 363, 427, 491, 555, 619, 683, 747, 811, 875, 939, 1003,
    44, 108, 172, 236, 300, 364, 428, 492, 556, 620, 684, 748, 812, 876, 940, 1004,
    45, 109, 173, 237, 301, 365, 429, 493, 557, 621, 685, 749, 813, 877, 941, 1005,
    46, 110, 174, 238, 302, 366, 430, 494, 558, 622, 686, 750, 814, 878, 942, 1006,
    47, 111, 175, 239, 303, 367, 431, 495, 559, 623, 687, 751, 815, 879, 943, 1007,
    48, 112, 176, 240, 304, 368, 432, 496, 560, 624, 688, 752, 816, 880, 944, 1008,
    49, 113, 177, 241, 305, 369, 433, 497, 561, 625, 689, 753, 817, 881, 945, 1009,
    50, 114, 178, 242, 306, 370, 434, 498, 562, 626, 690, 754, 818, 882, 946, 1010,
    51, 115, 179, 243, 307, 371, 435, 499, 563, 627, 691, 755, 819, 883, 947, 1011,
    52, 116, 180, 244, 308, 372, 436, 500, 564, 628, 692, 756, 820, 884, 948, 1012,
    53, 117, 181, 245, 309, 373, 437, 501, 565, 629, 693, 757, 821, 885, 949, 1013,
    54, 118, 182, 246, 310, 374, 438, 502, 566, 630, 694, 758, 822, 886, 950, 1014,
    55, 119, 183, 247, 311, 375, 439, 503, 567, 631, 695, 759, 823, 887, 951, 1015,
    56, 120, 184, 248, 312, 376, 440, 504, 568, 632, 696, 760, 824, 888, 952, 1016,
    57, 121, 185, 249, 313, 377, 441, 505, 569, 633, 697, 761, 825, 889, 953, 1017,
    58, 122, 186, 250, 314, 378, 442, 506, 570, 634, 698, 762, 826, 890, 954, 1018,
    59, 123, 187, 251, 315, 379, 443, 507, 571, 635, 699, 763, 827, 891, 955, 1019,
    60, 124, 188, 252, 316, 380, 444, 508, 572, 636, 700, 764, 828, 892, 956, 1020,
    61, 125, 189, 253, 317, 381, 445, 509, 573, 637, 701, 765, 829, 893, 957, 1021,
    62, 126, 190, 254, 318, 382, 446, 510, 574, 638, 702, 766, 830, 894, 958, 1022,
    63, 127, 191, 255, 319, 383, 447, 511, 575, 639, 703, 767, 831, 895, 959, 1023,
]

# CHIME:
#             quantity   frequency   east-west   east-west   north-south   north-south
# 
#   angular resolution     400 MHz    9.4 mrad       0.54°      7.5 mrad         0.43°
#   angular resolution     800 MHz    4.7 mrad       0.27°      3.7 mrad         0.21°
#        field of view     400 MHz   37.5 mrad       2.15°   1918.7 mrad       109.93°
#        field of view     800 MHz   18.7 mrad       1.07°    959.3 mrad        54.97°

host_dish_positions_buffer:
    kotekan_buffer: standard
    num_frames: 1
    frame_size: sizeof_float32 * 2 * num_dishes
    metadata_pool: main_pool

################################################################################

# ADC

adc_frequency: 1.6e+9           # [Hz]

################################################################################

# PFB

num_taps: 4
num_samples_per_frame: 4096

num_frequencies: 16       # 2048 frequencies / 64 gpus * 50% coverage
# The frequency channels we keep.
#     A channel's frequency is   freq = channel * adc_frequency / num_samples_per_frame
#     Note that   channel = freq = 0   is the DC channel.
#     Channel 1024 has 400 MHz for CHIME, channel 2048 has 800 MHz.
#     There are 2.56 channels per MHz, with a channel width of 390625 Hz.
# (These particular channels were chosen with a fixed step size between these channel boundaries.)
frequency_channels: [
    1024, 1088, 1152, 1216, 1280, 1344, 1408, 1472, 1536, 1600, 1664, 1728, 1792, 1856, 1920, 1984,
]

################################################################################

# Input frames

num_times: 16384

################################################################################

# Buffers

host_voltage_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_dishes * num_polarizations * num_frequencies * num_times
    metadata_pool: main_pool
host_voltage_ringbuffer:
    kotekan_buffer: ring
    ring_buffer_size: buffer_depth * num_dishes * num_polarizations * num_frequencies * num_times
    metadata_pool: main_pool

host_expected_bb_beams_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: num_times * num_polarizations * num_frequencies * bb_num_beams
    metadata_pool: main_pool

host_expected_frb1_beams_buffer:
    kotekan_buffer: standard
    num_frames: buffer_depth
    frame_size: sizeof_float16 * frb_num_beams_P * frb_num_beams_Q * upchan_all_max_num_output_channels * frb_num_output_times
    metadata_pool: main_pool

################################################################################

# Stages

run_fengine:
    kotekan_stage: FEngine
    num_frames: fengine_num_frames
    repeat_count: fengine_repeat_count
    # skip_julia: true
    join_timeout: 600
    dish_positions_buffer: host_dish_positions_buffer
    E_buffer: host_voltage_buffer
    bb_beam_positions_buffer: host_bb_beam_positions_buffer
    A_buffer: host_bb_phase_buffer
    s_buffer: host_bb_shift_buffer
    J_buffer: host_expected_bb_beams_buffer
    G_U2_buffer: host_upchan_U2_gain_buffer
    G_U4_buffer: host_upchan_U4_gain_buffer
    G_U8_buffer: host_upchan_U8_gain_buffer
    G_U16_buffer: host_upchan_U16_gain_buffer
    G_U32_buffer: host_upchan_U32_gain_buffer
    G_U64_buffer: host_upchan_U64_gain_buffer
    W1_U1_buffer: host_frb1_U1_phase_buffer
    W1_U2_buffer: host_frb1_U2_phase_buffer
    W1_U4_buffer: host_frb1_U4_phase_buffer
    W1_U8_buffer: host_frb1_U8_phase_buffer
    W1_U16_buffer: host_frb1_U16_phase_buffer
    W1_U32_buffer: host_frb1_U32_phase_buffer
    W1_U64_buffer: host_frb1_U64_phase_buffer
    W2_buffer: host_frb2_phase_buffer
    I1_buffer: host_expected_frb1_beams_buffer

run_send_voltage:
    gpu_0:
        kotekan_stage: cudaProcess
        gpu_id: 0
        in_buffers:
            host_voltage_buffer_in: host_voltage_buffer
        out_buffers:
            host_voltage_ringbuffer_out: host_voltage_ringbuffer
        commands:
        - name: cudaCopyToRingbuffer
          input_size: num_dishes * num_polarizations * num_frequencies * num_times
          ring_buffer_size: buffer_depth * input_size
          in_buf: host_voltage_buffer_in
          signal_buf: host_voltage_ringbuffer_out
          gpu_mem_output: voltage_buffer
