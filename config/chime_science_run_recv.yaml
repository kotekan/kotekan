##########################################
#
# chime_science_run_recv.yaml
#
# CHIME receiver node configuration used in the mid-November 2018 run.
# This configuration turns off saving of the 26m datasets.
#
# For the N2 data it includes, 10 second calibration data,
# full triangles for 10 frequencies at 10 seconds, and stacked
# data over all frequencies.
#
# Author: Richard Shaw
#
##########################################
---
type: config
log_level: info
num_elements: 2048
num_local_freq: 1
udp_packet_size: 4928
num_data_sets: 1
samples_per_data_set: 32768
buffer_depth: 64
num_gpu_frames: 128
block_size: 32
cpu_affinity: [4,5,6,7,12,13,14,15]
num_ev: 4
use_dataset_manager: True

dataset_manager:
  use_dataset_broker: True
  ds_broker_host: "10.1.50.11" # recv1

vis_pool:
  kotekan_metadata_pool: visMetadata
  num_metadata_objects: 500 * buffer_depth

vis_buffer:
  metadata_pool: vis_pool
  num_frames: buffer_depth
  visbuf_10s_all:
    kotekan_buffer: vis
  visbuf_10s_gain:
    kotekan_buffer: vis
  visbuf_10s_flags:
    kotekan_buffer: vis
    buffer_depth: 512  # This is immediately before the first slow process so it needs a longer length
  visbuf_10s_stack:
    kotekan_buffer: vis
    num_prod: 17000  # Approximation to the correct size
  visbuf_10s_mfreq:
    kotekan_buffer: vis
  visbuf_10s_stack_mfreq:
    kotekan_buffer: vis
  visbuf_5s_26m:
    kotekan_buffer: vis
    buffer_depth: 4096
    num_prod: 4096
  visbuf_10s_cal:
    kotekan_buffer: vis
    num_prod: 2048
    buffer_depth: 1024  # Increase as this subset is produced very quickly
  visbuf_10s_timing:
    num_prod: 66
    kotekan_buffer: vis
    buffer_depth: 1024  # Increase as this subset is produced very quickly

# Subset of good frequencies to output whole for monitoring
mfreq: &mfreq [107, 344, 619, 938]

# Updatable config blocks
updatable_config:
  flagging:
    kotekan_update_endpoint: "json"
    start_time: 1535048997.
    tag: "initial_flags"
    bad_inputs: [ ]
  gains:
    kotekan_update_endpoint: "json"
    start_time: 1541039597.
    tag: "gain_20181101T023317.440691Z_cyga"


# Kotekan processes
buffer_recv:
  n2:
    kotekan_process: bufferRecv
    buf: visbuf_10s_all
    listen_port: 11024
    cpu_affinity: [0, 8]
    num_threads: 2
  26m:
    kotekan_process: bufferRecv
    buf: visbuf_5s_26m
    listen_port: 11025
#  26m_gated:
#    kotekan_process: bufferRecv
#    buf: visbuf_5s_26m
#    listen_port: 11026

apply_flags:
  kotekan_process: receiveFlags
  in_buf: visbuf_10s_all
  out_buf: visbuf_10s_flags
  updatable_config: "/updatable_config/flagging"

vis_debug:
  n2:
    kotekan_process: visDebug
    in_buf: visbuf_10s_flags
  26m:
    kotekan_process: visDebug
    in_buf: visbuf_5s_26m

count_check:
  n2:
    kotekan_process: countCheck
    in_buf: visbuf_10s_flags
  26m:
    kotekan_process: countCheck
    in_buf: visbuf_5s_26m

apply_gains:
  cpu_affinity: [1]
  kotekan_process: applyGains
  in_buf: visbuf_10s_flags
  out_buf: visbuf_10s_gain
  gains_dir: "/mnt/recv1/calibration/gain_updates/"
  updatable_config: "/updatable_config/gains"

stacking:
  kotekan_process: baselineCompression
  in_buf: visbuf_10s_gain
  out_buf: visbuf_10s_stack
  stack_type: chime_in_cyl
  exclude_inputs: [
    46, 142, 688, 944, 960, 1058, 1166, 1225, 1314, 1521, 1543, 2032, 2034,
    221, 222, 384, 385, 386, 387, 424, 425, 426, 427, 552, 553, 644, 645,    # Cable swaps feeds (and following lines)
    646, 647, 650, 651, 672, 673, 674, 675, 682, 683, 906, 907, 1134, 1135,
    1910, 1911, 1950, 1951
  ]
  num_threads: 2
  cpu_affinity: [2, 3]

buffer_status:
  kotekan_process: bufferStatus
  print_status: false

# Generate the calibration stream
cal_subset:
  kotekan_process: prodSubset
  in_buf: visbuf_10s_flags
  out_buf: visbuf_10s_cal
  prod_subset_type: autos

timing_subset:
  kotekan_process: prodSubset
  in_buf: visbuf_10s_flags
  out_buf: visbuf_10s_timing
  prod_subset_type: only_inputs
  input_list: [46, 142, 688, 944, 960, 1058, 1166, 1314, 1543, 2032, 2034]

# Generate the monitoring freq full N^2 stream
mfreq_subset:
  subset_list: *mfreq  # 10 good frequencies within the upper 1/4 band
  n2:
    kotekan_process: freqSubset
    in_buf: visbuf_10s_flags
    out_buf: visbuf_10s_mfreq
#  stack:
#    kotekan_process: freqSubset
#    in_buf: visbuf_10s_stack
#    out_buf: visbuf_10s_stack_mfreq

buffer_writers:
  file_length: 256
  root_path: /mnt/recv1/buffer/
  write_ev: True
  file_base: buffer

  cal:
    kotekan_process: visCalWriter
    in_buf: visbuf_10s_cal
    instrument_name: chimecal
    file_length: 256
    dir_name: cal

  timing:
    kotekan_process: visCalWriter
    in_buf: visbuf_10s_timing
    instrument_name: chimetiming
    dir_name: timing

archive_writers:

  file_length: 512
  file_type: raw
  write_ev: True
  root_path: /data/untransposed/

  n2_mf:
    kotekan_process: visWriter
    in_buf: visbuf_10s_mfreq
    instrument_name: chimeN2

  chimestack:
    kotekan_process: visWriter
    in_buf: visbuf_10s_stack
    instrument_name: chimestack

#  26m:
#    kotekan_process: visWriter
#    in_buf: visbuf_5s_26m
#    instrument_name: chime26m

#  26m_gated:
#    kotekan_process: visWriter
#    in_buf: visbuf_5s_26m
#    instrument_name: chime26mgated

  cal:
    kotekan_process: visWriter
    in_buf: visbuf_10s_cal
    instrument_name: chimecal
    file_length: 256

  timing:
    kotekan_process: visWriter
    in_buf: visbuf_10s_timing
    instrument_name: chimetiming
    write_ev: False


# Transmit part of the stack to the recv1 for testing
#buffer_send:
#  server_ip: 10.1.50.11
#  stack_mfreq:
#    kotekan_process: bufferSend
#    buf: visbuf_10s_stack_mfreq
#    server_port: 14096
