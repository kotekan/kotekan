##########################################
#
# pathfinder_rfi_280x.yaml
#
# A config for pathfinder which uses
# all availoiable rfi pipeline stages
#
# Author: Jacob Taylor
#
##########################################
---
type: config
# Logging level can be one of:
# OFF, ERROR, WARN, INFO, DEBUG, DEBUG2 (case insensitive)
# Note DEBUG and DEBUG2 require a build with (-DCMAKE_BUILD_TYPE=Debug)
log_level: INFO

instrument_name: pathfinder

num_elements: 256
num_adjusted_elements: 256
num_local_freq: 8
num_adjusted_local_freq: 8
num_total_freq: 1024
#num_adjusted_elements/block_size * (num_adjusted_elements/block_size + 1)/2; block_size = 32.
num_blocks: 36
block_size: 32
samples_per_data_set: 32768
num_data_sets: 1
buffer_depth: 6
num_gpu_frames: 256
num_gpus: 3
cpu_affinity: [4,5,10,11]
enable_gating: false
sizeof_cl_int: 4
sizeof_tcp_frame_header: 116
sizeof_complex_int_t: 8
sizeof_per_frequency_data: 16
sizeof_per_element_data: 12
sizeof_uint8_t: 1
sizeof_gate_frame_header: 236
sizeof_float: 4
num_links_fury: 8
num_links_per_gpu: 1

num_links: 8
link_map: [0,0,1,1,1,2,2,2]
num_links_270: 2
num_links_280: 3

#RFI stuff
sk_step: 256
rfi_combined: True
frames_per_packet: 1
bad_inputs: []

# Pool
main_pool:
    kotekan_metadata_pool: chimeMetadata
    num_metadata_objects: 10 * buffer_depth * num_links

gpu_input_buffers:
    frame_size: samples_per_data_set * num_elements * num_local_freq * num_data_sets
    metadata_pool: main_pool
    gpu_280_input_buffer_0:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_280
    gpu_280_input_buffer_1:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_280
    gpu_270_input_buffer_0:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_270

gpu_output_buffers:
    frame_size: num_local_freq * num_blocks * (block_size*block_size)*2.*num_data_sets  * sizeof_cl_int
    metadata_pool: main_pool
    gpu_output_buffer_0:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_270
    gpu_output_buffer_1:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_280
    gpu_output_buffer_2:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_280

gpu_rfi_output_buffers:
    frame_size: num_local_freq * (samples_per_data_set/sk_step) * sizeof_float
    metadata_pool: main_pool
    gpu_rfi_output_buffer_0:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_270
    gpu_rfi_output_buffer_1:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_280
    gpu_rfi_output_buffer_2:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_280


beamform_output_buffers:
    frame_size: samples_per_data_set * num_data_sets * num_local_freq * 2
    metadata_pool: main_pool
    beam_output_buffer_0:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_270
    beam_output_buffer_1:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_280
    beam_output_buffer_2:
        kotekan_buffer: standard
        num_frames: buffer_depth * num_links_280

dpdk:
  kotekan_stage: dpdkWrapper
  mode: no_shuffle
  num_lcores: 4
#  udp_packet_size: 4800  
  udp_packet_size: 4160
  timesamples_per_packet: 2
  network_out_buf_0: gpu_270_input_buffer_0
  network_out_buf_1: gpu_280_input_buffer_0
  network_out_buf_2: gpu_280_input_buffer_1

#gen_data:
#  type: random
#  value: 153
#  test_data_gen_0:
#    kotekan_stage: testDataGen
#    network_out_buf: gpu_270_input_buffer_0
#  test_data_gen_1:
#    kotekan_stage: testDataGen
#    network_out_buf: gpu_280_input_buffer_0
#  test_data_gen_2:
#    kotekan_stage: testDataGen
#    network_out_buf: gpu_280_input_buffer_1

gpu:
  commands:
  - name: input_data_stage
    kernel: ''
  - name: clRfiTimeSum
    kernel: "../lib/opencl/kernels/rfi_chime_timesum_private.cl"
  - name: clRfiInputSum
    kernel: "../lib/opencl/kernels/rfi_chime_inputsum.cl"
  - name: beamform_phase_data
    kernel: ''
  - name: offset_accumulator
    kernel: "../lib/opencl/kernels/offset_accumulator.cl"
  - name: preseed_multifreq
    kernel: "../lib/opencl/kernels/preseed_multifreq.cl"
  - name: pairwise_correlator
    kernel: "../lib/opencl/kernels/pairwise_correlator.cl"
  - name: beamform_kernel
    kernel: "../lib/opencl/kernels/beamform_tree_scale.cl"
  - name: output_beamform_result
    kernel: ''
  - name: clRfiOutput
    kernel: ''
  - name: output_data_result
    kernel: ''
  ts_element_offset: 0
  ts_num_elem_to_shift: 0
  ts_samples_to_shift: 0
  use_timeshift: 0
  enable_beamforming: true
  instrument_lat: 49.3203
  instrument_long: -119.6175
  ra: 53.5
  dec: 54.6
  element_positions: [-0.38928000000000001, 11.226240000000001, -0.37872, 10.92164, -0.36815999999999999, 10.61702, -0.35759000000000002, 10.3124, -0.34703000000000001, 10.00778, -0.33646999999999999, 9.7031500000000008, -0.32590999999999998, 9.3985500000000002, -0.31534000000000001, 9.0939300000000003, -0.30478, 8.78932, -0.29421999999999998, 8.4847000000000001, -0.28365000000000001, 8.1800800000000002, -0.27309, 7.87547, -0.26252999999999999, 7.5708500000000001, -0.25196000000000002, 7.2662300000000002, -0.2414, 6.9616199999999999, -0.23083999999999999, 6.657, -0.22028, 6.3523800000000001, -0.20971000000000001, 6.0477499999999997, -0.19914999999999999, 5.74315, -0.18859000000000001, 5.4385300000000001, -0.17802000000000001, 5.1339100000000002, -0.16746, 4.8292999999999999, -0.15690000000000001, 4.52468, -0.14634, 4.2200600000000001, -0.13577, 3.9154499999999999, -0.12520999999999999, 3.61083, -0.11465, 3.3062100000000001, -0.10408000000000001, 3.0015999999999998, -0.093520000000000006, 2.6969799999999999, -0.082960000000000006, 2.39236, -0.072389999999999996, 2.0877500000000002, -0.061830000000000003, 1.7831300000000001, -0.051270000000000003, 1.47851, -0.040710000000000003, 1.1738900000000001, -0.03014, 0.86928000000000005, -0.01958, 0.56466000000000005, -0.0090200000000000002, 0.26003999999999999, 0.0015499999999999999, -0.044569999999999999, 0.012109999999999999, -0.34919, 0.022669999999999999, -0.65381, 0.033230000000000003, -0.95842000000000005, 0.043799999999999999, -1.2630399999999999, 0.054359999999999999, -1.5676600000000001, 0.064920000000000005, -1.8722700000000001, 0.075490000000000002, -2.1768900000000002, 0.086050000000000001, -2.4815100000000001, 0.096610000000000001, -2.78613, 0.10717, -3.0907399999999998, 0.11774, -3.3953600000000002, 0.1283, -3.69998, 0.13886000000000001, -4.0045900000000003, 0.14943000000000001, -4.3092100000000002, 0.15998999999999999, -4.6138300000000001, 0.17055000000000001, -4.9184400000000004, 0.18112, -5.2230600000000003, 0.19167999999999999, -5.5276800000000001, 0.20224, -5.8322900000000004, 0.21279999999999999, -6.1369100000000003, 0.22337000000000001, -6.4415300000000002, 0.23393, -6.7461500000000001, 0.24449000000000001, -7.0507600000000004, 0.25506000000000001, -7.3553800000000003, 0.26562000000000002, -7.6600000000000001, 0.27617999999999998, -7.9646100000000004, -0.38928000000000001, 10.91107, -0.37872, 10.92164, -0.36815999999999999, 10.61702, -0.35759000000000002, 10.3124, -0.34703000000000001, 10.00778, -0.33646999999999999, 9.7031700000000001, -0.32590999999999998, 9.3985500000000002, -0.31534000000000001, 9.0939300000000003, -0.30478, 8.78932, -0.29421999999999998, 8.4847000000000001, -0.28365000000000001, 8.1800800000000002, -0.27309, 7.87547, -0.26252999999999999, 7.5708500000000001, -0.25196000000000002, 7.2662300000000002, -0.2414, 6.9616199999999999, -0.23083999999999999, 6.657, -0.22028, 6.3523800000000001, -0.20971000000000001, 6.0477699999999999, -0.19914999999999999, 5.74315, -0.18859000000000001, 5.4385300000000001, -0.17802000000000001, 5.1339100000000002, -0.16746, 4.8292999999999999, -0.15690000000000001, 4.52468, -0.14634, 4.2200600000000001, -0.13577, 3.9154499999999999, -0.12520999999999999, 3.61083, -0.11465, 3.3062100000000001, -0.10408000000000001, 3.0015999999999998, -0.093520000000000006, 2.6969599999999998, -0.082960000000000006, 2.39236, -0.072389999999999996, 2.0877500000000002, -0.061830000000000003, 1.7831300000000001, -0.051270000000000003, 1.47851, -0.040710000000000003, 1.1738900000000001, -0.03014, 0.86928000000000005, -0.01958, 0.56466000000000005, -0.0090200000000000002, 0.26003999999999999, 0.0015499999999999999, -0.044569999999999999, 0.012109999999999999, -0.34919, 0.022669999999999999, -0.65381, 0.033230000000000003, -0.95842000000000005, 0.043799999999999999, -1.2630399999999999, 0.054359999999999999, -1.5676600000000001, 0.064920000000000005, -1.8722700000000001, 0.075490000000000002, -2.1768900000000002, 0.086050000000000001, -2.4815100000000001, 0.096610000000000001, -2.78613, 0.10717, -3.0907399999999998, 0.11774, -3.3953600000000002, 0.1283, -3.69998, 0.13886000000000001, -4.0045900000000003, 0.14943000000000001, -4.3092100000000002, 0.15998999999999999, -4.6138300000000001, 0.17055000000000001, -4.9184400000000004, 0.18112, -5.2230600000000003, 0.19167999999999999, -5.5276800000000001, 0.20224, -5.8323099999999997, 0.21279999999999999, -6.1369100000000003, 0.22337000000000001, -6.4415300000000002, 0.23393, -6.7461500000000001, 0.24449000000000001, -7.0507600000000004, 0.25506000000000001, -7.3553800000000003, 0.26562000000000002, -7.6600000000000001, 0.27617999999999998, -7.9646100000000004, 21.595610000000001, 12.043240000000001, 21.606169999999999, 11.738619999999999, 21.61674, 11.433999999999999, 21.627300000000002, 11.129390000000001, 21.637889999999999, 10.823969999999999, 21.64845, 10.519349999999999, 21.659020000000002, 10.214740000000001, 21.66958, 9.9101199999999992, 21.68017, 9.6046999999999993, 21.690729999999999, 9.3000900000000009, 21.70129, 8.9954699999999992, 21.711860000000001, 8.6908499999999993, 21.722100000000001, 8.3954299999999993, 21.732659999999999, 8.0908099999999994, 21.743230000000001, 7.7862, 21.753789999999999, 7.4815800000000001, 21.76473, 7.1661700000000002, 21.775289999999998, 6.8615300000000001, 21.78585, 6.5569300000000004, 21.796420000000001, 6.2523200000000001, 21.807009999999998, 5.9469000000000003, 21.81757, 5.6422800000000004, 21.828130000000002, 5.3376700000000001, 21.838699999999999, 5.0330500000000002, 21.84929, 4.7276300000000004, 21.859850000000002, 4.4230200000000002, 21.87041, 4.1184000000000003, 21.880980000000001, 3.8137799999999999, 21.891220000000001, 3.5183599999999999, 21.901779999999999, 3.21374, 21.91235, 2.9091300000000002, 21.922910000000002, 2.6045099999999999, 21.933499999999999, 2.2990900000000001, 21.94406, 1.99448, 21.954630000000002, 1.6898599999999999, 21.96519, 1.38524, 21.97578, 1.0798300000000001, 21.986339999999998, 0.77520999999999995, 21.9969, 0.47059000000000001, 22.007470000000001, 0.16597999999999999, 22.018059999999998, -0.13944000000000001, 22.02862, -0.44406000000000001, 22.039180000000002, -0.74868000000000001, 22.04975, -1.0532900000000001, 22.06034, -1.3587100000000001, 22.070900000000002, -1.66333, 22.08146, -1.96794, 22.092030000000001, -2.2725599999999999, 22.102620000000002, -2.5779800000000002, 22.11318, -2.88259, 22.123740000000002, -3.1872099999999999, 22.134309999999999, -3.4918300000000002, 22.1449, -3.7972399999999999, 22.155460000000001, -4.1018600000000003, 22.16602, -4.4064800000000002, 22.176590000000001, -4.7110900000000004, 22.187180000000001, -5.0165100000000002, 22.19774, -5.3211300000000001, 22.208300000000001, -5.6257400000000004, 22.218859999999999, -5.9303600000000003, 22.22946, -6.2357800000000001, 22.240020000000001, -6.5403900000000004, 22.250579999999999, -6.8450300000000004, 22.261140000000001, -7.1496300000000002, 21.595610000000001, 12.043240000000001, 21.606169999999999, 11.738619999999999, 21.61674, 11.433999999999999, 21.627300000000002, 11.129390000000001, 21.637889999999999, 10.823969999999999, 21.64845, 10.519349999999999, 21.659020000000002, 10.214740000000001, 21.66958, 9.9101199999999992, 21.68017, 9.6046999999999993, 21.690729999999999, 9.3000900000000009, 21.70129, 8.9954699999999992, 21.711860000000001, 8.6908499999999993, 21.722100000000001, 8.3954299999999993, 21.732659999999999, 8.0908099999999994, 21.743230000000001, 7.7862, 21.753979999999999, 7.4707699999999999, 21.76473, 7.1661700000000002, 21.775289999999998, 6.8615500000000003, 21.78585, 6.5569300000000004, 21.796420000000001, 6.2523200000000001, 21.807009999999998, 5.9469000000000003, 21.81757, 5.6422800000000004, 21.828130000000002, 5.3376700000000001, 21.838699999999999, 5.0330500000000002, 21.84929, 4.7276300000000004, 21.859850000000002, 4.4230200000000002, 21.87041, 4.1184000000000003, 21.880980000000001, 3.8137799999999999, 21.891220000000001, 3.5183599999999999, 21.901779999999999, 3.21373, 21.91235, 2.9091300000000002, 21.922920000000001, 2.6036899999999998, 21.933499999999999, 2.2990900000000001, 21.94406, 1.99448, 21.954630000000002, 1.6898599999999999, 21.96519, 1.38524, 21.97578, 1.0798300000000001, 21.986339999999998, 0.77520999999999995, 21.9969, 0.47059000000000001, 22.007470000000001, 0.16597999999999999, 22.018059999999998, -0.13944000000000001, 22.02862, -0.44406000000000001, 22.039180000000002, -0.74868000000000001, 22.04975, -1.0532900000000001, 22.06034, -1.3587100000000001, 22.070900000000002, -1.66333, 22.08146, -1.96794, 22.092030000000001, -2.2725599999999999, 22.102620000000002, -2.5779800000000002, 22.11318, -2.88259, 22.123740000000002, -3.1872099999999999, 22.134309999999999, -3.4918300000000002, 22.1449, -3.7972399999999999, 22.155460000000001, -4.1018600000000003, 22.16602, -4.4064800000000002, 22.176590000000001, -4.7110900000000004, 22.187180000000001, -5.0165100000000002, 22.19774, -5.3211300000000001, 22.208300000000001, -5.6257400000000004, 22.218859999999999, -5.9303600000000003, 22.22946, -6.2357800000000001, 22.240020000000001, -6.5403900000000004, 22.250579999999999, -6.8450100000000003, 22.261140000000001, -7.14961]
  element_mask: []
  scale_factor: 1.0
  do_not_track: 1
  fixed_time: 1441828309
  product_remap: [92,  93,  94,  95,  88,  89,  90,  91,  84,  85,  86,  87,  80,  81,  82,  83,  28,  29,  30,  31,  24,  25,  26,  27,  20,  21,  22,  23,  16,  17,  18,  19,  76,  77,  78,  79,  72,  73,  74,  75,  68,  69,  70,  71,  64,  65,  66,  67,  12,  13,  14,  15,  8,  9,  10,  11,  4,  5,  6,  7,  0,  1,  2,  3,  220,  221,  222,  223,  216,  217,  218,  219,  212,  213,  214,  215,  208,  209,  210,  211,  156,  157,  158,  159,  152,  153,  154,  155,  148,  149,  150,  151,  144,  145,  146,  147,  204,  205,  206,  207,  200,  201,  202,  203,  196,  197,  198,  199,  192,  193,  194,  195,  140,  141,  142,  143,  136,  137,  138,  139,  132,  133,  134,  135,  128,  129,  130,  131,  252,  253,  254,  255,  248,  249,  250,  251,  244,  245,  246,  247,  240,  241,  242,  243,  188,  189,  190,  191,  184,  185,  186,  187,  180,  181,  182,  183,  176,  177,  178,  179,  236,  237,  238,  239,  232,  233,  234,  235,  228,  229,  230,  231,  224,  225,  226,  227,  172,  173,  174,  175,  168,  169,  170,  171,  164,  165,  166,  167,  160,  161,  162,  163,  124,  125,  126,  127,  120,  121,  122,  123,  116,  117,  118,  119,  112,  113,  114,  115,  60,  61,  62,  63,  56,  57,  58,  59,  52,  53,  54,  55,  48,  49,  50,  51,  108,  109,  110,  111,  104,  105,  106,  107,  100,  101,  102,  103,  96,  97,  98,  99,  44,  45,  46,  47,  40,  41,  42,  43,  36,  37,  38,  39,  32,  33,  34,  35]
  gpu_0:
    kotekan_stage: clProcess
    gpu_id: 0
    network_buffer: gpu_270_input_buffer_0
    output_buffer: gpu_output_buffer_0
    beam_out_buf: beam_output_buffer_0
    rfi_out_buf: gpu_rfi_output_buffer_0
  gpu_1:
    kotekan_stage: clProcess
    gpu_id: 1
    network_buffer: gpu_280_input_buffer_0
    output_buffer: gpu_output_buffer_1
    beam_out_buf: beam_output_buffer_1
    rfi_out_buf: gpu_rfi_output_buffer_1
  gpu_2:
    kotekan_stage: clProcess
    gpu_id: 2
    network_buffer: gpu_280_input_buffer_1
    output_buffer: gpu_output_buffer_2
    beam_out_buf: beam_output_buffer_2
    rfi_out_buf: gpu_rfi_output_buffer_2

rfi_broadcast:
  destination_protocol: UDP
#  destination_ip: 10.10.10.2
  destination_ip: 127.0.0.1
  gpu_0:
    total_links: 2
    destination_port: 41216
    kotekan_stage: rfiBroadcast
    rfi_in: gpu_rfi_output_buffer_0
  gpu_1:
    total_links: 3
    destination_port: 41217
    kotekan_stage: rfiBroadcast
    rfi_in: gpu_rfi_output_buffer_1
  gpu_2:
    total_links: 3
    destination_port: 41218
    kotekan_stage: rfiBroadcast
    rfi_in: gpu_rfi_output_buffer_2

rfi_record:
  write_to: /mnt/glock/RFI
  write_to_disk: false
  gpu_0:
    total_links: 2
    kotekan_stage: rfiRecord
    rfi_in: gpu_rfi_output_buffer_0
  gpu_1:
    total_links: 3
    rfi_in: gpu_rfi_output_buffer_1
  gpu_2:
    total_links: 3
    kotekan_stage: rfiRecord
    rfi_in: gpu_rfi_output_buffer_2

#RFI Live-view Paramters
waterfallX: 1024
num_receive_threads: 4
colorscale: 0.5
waterfall_request_delay: 60
